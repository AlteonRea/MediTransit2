<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardbox Packing</title>
    <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/CardboardPacking.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
</head>
<body>
    <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark sidebar">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
            <span class="fs-4">MediTransit</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li>
                <a href="VehiclePacking.html" id="vehicle-link" class="nav-link text-white">
                    <svg class="bi me-2" width="16" height="16"><use xlink:href="#grid"/></svg>
                    Vehicle Packing
                </a>
            </li>
            <li>
                <a href="#" class="nav-link active">
                    <svg class="bi me-2" width="16" height="16"><use xlink:href="#people-circle"/></svg>
                    Cardbox Packing
                </a>
            </li>
        </ul>
        <label for="shipment-id-select" class="form-label text-white">Select Shipment ID:</label>
        <select id="shipment-id-select" class="form-select">
            <option value="">No Shipment</option>
        </select>
        <button id="loadDataBtn" class="btn btn-primary mt-2">Load Data</button>
        <hr>
        <div class="dropdown">
            <h4 id="name">Packer</h4>
          </a>
        </div>
    </div>

    <div id="container"></div>

    <script>
        const containerElem = document.getElementById("container");
        const loadDataBtn = document.getElementById("loadDataBtn");
        const shipmentIdSelect = document.getElementById("shipment-id-select");

        document.addEventListener("DOMContentLoaded", async function(){
            const response = await fetch ('/shipmentIdList');
            const dataIdList = await response.json();
            console.log(dataIdList);
            if(dataIdList.length > 0){
                shipmentIdSelect.innerHTML = '';
                
                dataIdList.forEach((item) => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.innerHTML = `Shipment ${item.id}`;
                    shipmentIdSelect.appendChild(option);
                })
            };
        });

        loadDataBtn.addEventListener("click", function(){
            containerElem.innerHTML = '';
            async function getData() {
                try {
                    const shipmentId = shipmentIdSelect.value;
                    const response = await fetch (`/cardboxIDnItemCount?shipmentId=${shipmentId}`);
                    const data = await response.json();
                    console.log('SHIPMENT ID: ', shipmentId);
                    console.log(data);
        
                    if (data.length > 0) {
                        let boxIndex = 0;
                        for (const box of data) {
                            console.log('Box ke-', boxIndex);
                            const boxPos = [0,0,0];
                            const boxSize = [box.size_x, box.size_y, box.size_z];
                            let itemPosList = [];
                            let itemSizeList = [];
                            let productCodeList = []
                            const cardboxId = box.cardboardbox_instance_id;
                            const itemAmount = box.jumlah_item_dalam_kardus;
                            console.log('Box pos: ', boxPos);
                            console.log('Box Size: ', boxSize);
                            const response2 = await fetch(`/listItemOfCardbox?shipmentId=${shipmentId}&cardboxId=${cardboxId}`);
                            const data2 = await response2.json();
                            console.log('Data of cardboard box instance id: ', box.cardboardbox_instance_id);
                            data2.forEach((item) => {
                                itemPosList.push([item.pos_x, item.pos_y, item.pos_z]);
                                itemSizeList.push([item.size_x, item.size_y, item.size_z]);
                                productCodeList.push(item.product_code);
                            });
                            console.log("item pos: ", itemPosList);
                            console.log("item size: ", itemSizeList);
                            generateAnim(boxPos, boxSize, itemPosList, itemSizeList, productCodeList);

                            
                            boxIndex++;
                        }
                    }
                    //generateAnim();
        
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }
        
            function generateAnim(boxPos, boxSize, itemPosList, itemSizeList, productCodeList){
                function getCubeEdges(pos,size){
                    var x1 = [pos[0], pos[0]+size[0], pos[0]+size[0], pos[0]];
                    var y1 = [pos[1], pos[1], pos[1]+size[1], pos[1]+size[1]];
                    var z1 = [pos[2], pos[2], pos[2], pos[2]];
                    
                    var x2 = [pos[0], pos[0], pos[0], pos[0]];
                    var y2 = [pos[1], pos[1], pos[1]+size[1], pos[1]+size[1]];
                    var z2 = [pos[2], pos[2]+size[2], pos[2]+size[2], pos[2]];
            
                    var x3 = [pos[0], pos[0]+size[0], pos[0]+size[0]];
                    var y3 = [pos[1]+size[1], pos[1]+size[1], pos[1]+size[1]];
                    var z3 = [pos[2]+size[2], pos[2]+size[2], pos[2]];
            
                    var x4 = [pos[0]+size[0], pos[0]+size[0], pos[0]+size[0]];
                    var y4 = [pos[1]+size[1], pos[1], pos[1]];
                    var z4 = [pos[2]+size[2], pos[2]+size[2], pos[2]];
            
                    var x5 = [pos[0]+size[0], pos[0]];
                    var y5 = [pos[1], pos[1]];
                    var z5 = [pos[2]+size[2], pos[2]+size[2]];
            
                    var x = x1.concat(x2, x3, x4, x5);
                    var y = y1.concat(y2, y3, y4, y5);
                    var z = z1.concat(z2, z3, z4, z5);
                    return [x,y,z];
                }
            
                function getEdgesImg(pos, size, color){
                    var [boxX, boxY, boxZ] = getCubeEdges(pos, size);
                    var box_img = {
                        type: 'scatter3d',
                        mode: 'lines',
                        x: boxX,
                        y: boxY,
                        z: boxZ,
                        line: {
                            width: 6,
                            color: color,
                            reversescale: false
                        }
                    };
                    return box_img;
                }
            
                function getCubeMesh(pos, size){
                    var meshX= [pos[0],         pos[0],         pos[0]+size[0], pos[0]+size[0], pos[0],         pos[0],         pos[0]+size[0], pos[0]+size[0]];    
                    var meshY= [pos[1], pos[1]+size[1], pos[1]+size[1], pos[1],         pos[1],         pos[1]+size[1], pos[1]+size[1], pos[1],       ];   
                    var meshZ= [pos[2],         pos[2],         pos[2],         pos[2],         pos[2]+size[2], pos[2]+size[2], pos[2]+size[2], pos[2]+size[2]];        
                    return [meshX, meshY, meshZ];
                }
            
                function getMeshImg(pos, size, color){
                    var [meshX, meshY, meshZ] = getCubeMesh(pos, size);
                    img = {
                        type: "mesh3d",
                        x: meshX,
                        y: meshY,
                        z: meshZ,
                        i: [7, 0, 0, 0, 4, 4, 6, 6, 4, 0, 3, 2],
                        j: [3, 4, 1, 2, 5, 6, 5, 2, 0, 1, 6, 3],
                        k: [0, 7, 2, 3, 6, 7, 1, 1, 5, 5, 7, 6],
                        color:color
                    };
                    return img;
                }
            
                function drawBox(boxPos, boxSize, itemPosList, itemSizeList, lastItemIdx, divName, leftContainerDiv, productCodeList, rightContainerDiv) {
                    var plotlyData = [];
                    var box_img = getEdgesImg(boxPos, boxSize, 'red');
                    
                    // CREATE BUTTON CONTAINER
                    const buttonContainer = document.createElement('div');
                    buttonContainer.classList.add('button-container');
                
                    // CREATE PREV NEXT BUTTON
                    const leftButton = document.createElement('button');
                    leftButton.textContent = '<';
                    leftButton.classList.add('btn', 'btn-primary', 'mr-2');
                    
                
                    const rightButton = document.createElement('button');
                    rightButton.textContent = '>';
                    rightButton.classList.add('btn', 'btn-primary', 'mr-2');
                    
                    
                    // CREATE FIRST INDEX BUTTON AND LAST INDEX BUTTON
                    const firstButton = document.createElement('button');
                    firstButton.textContent = '<<';
                    firstButton.classList.add('btn', 'btn-primary', 'mr-2');
                    

                    const lastButton = document.createElement('button');
                    lastButton.textContent = '>>';
                    lastButton.classList.add('btn', 'btn-primary', 'mr-2');
                    
                    // CREATE SEARCH INDEX BY INPUT
                    const form = document.createElement('form');
                    
                    const inputNumber = document.createElement('input');
                    inputNumber.type = 'number';
                    inputNumber.min = 0;
                    inputNumber.step = 1;
                    inputNumber.value = lastItemIdx;
                    inputNumber.classList.add('form-control', 'mr-2');

                    console.log(productCodeList);
                    const table = document.createElement('table');
                    table.classList.add('table', 'table-striped', 'table-bordered');

                    const thead = document.createElement('thead');
                    thead.innerHTML = `<th scope = "col">Number</th> <th scope = "col">Product Code</th>`;

                   

                    const tbody = document.createElement('tbody');

                    productCodeList.forEach((code, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${index+1}</td>
                        <td>${code}</td>
                        `;
                        tbody.appendChild(row);
                    })


                    table.appendChild(thead);
                    table.appendChild(tbody);

                    rightContainerDiv.appendChild(table);
                    form.appendChild(inputNumber);

                    buttonContainer.appendChild(firstButton);
                    buttonContainer.appendChild(leftButton);
                    buttonContainer.appendChild(form);
                    buttonContainer.appendChild(rightButton);
                    buttonContainer.appendChild(lastButton);

                    
                    leftContainerDiv.appendChild(buttonContainer);
                    

                    function updateInputValue(){
                        inputNumber.value = lastItemIdx;
                    }
                    // EVENT HANDLER FOR BUTTONS
                    leftButton.addEventListener('click', () => {
                        if (lastItemIdx > 0) {
                            lastItemIdx--;
                            updateInputValue();
                            updatePlot();
                        }
                    });
                
                    rightButton.addEventListener('click', () => {
                        if (lastItemIdx < itemPosList.length - 1) {
                            lastItemIdx++;
                            updateInputValue();
                            updatePlot();
                        }
                    });

                    firstButton.addEventListener('click', () => {
                        lastItemIdx = 0;
                        updateInputValue();
                        updatePlot();
                    });

                    lastButton.addEventListener('click', () => {
                        lastItemIdx = itemPosList.length - 1;
                        updateInputValue();
                        updatePlot();
                    });

                    form.addEventListener('submit', (event) => {
                        event.preventDefault(); 
                        let inputValue = parseInt(inputNumber.value);
                        console.log(inputValue);
                        console.log(inputNumber.value);
                        if (!isNaN(inputValue)) {
                            if(inputValue < 0) inputValue = 0;
                            else if(inputValue > itemPosList.length - 1) inputValue = itemPosList.length - 1;
                            lastItemIdx = inputValue;
                            updateInputValue();
                            updatePlot();
                        }
                    });

                    inputNumber.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault(); 
                            form.dispatchEvent(new Event('submit'));
                        }
                    });
                
                    function updatePlot() {
                        plotlyData = [box_img];
                
                        for (let i = 1; i <= lastItemIdx; i++) {
                            var item_img = getMeshImg(itemPosList[i-1], itemSizeList[i-1], 'grey');
                            var item_edge_img = getEdgesImg(itemPosList[i], itemSizeList[i], 'black');
                            plotlyData = plotlyData.concat([item_img, item_edge_img]);
                        }
                
                        if (lastItemIdx < itemPosList.length) {
                            var item_img = getMeshImg(itemPosList[lastItemIdx], itemSizeList[lastItemIdx], 'blue');
                            var item_edge_img = getEdgesImg(itemPosList[lastItemIdx], itemSizeList[lastItemIdx], 'black');
                            plotlyData = plotlyData.concat([item_img, item_edge_img]);
                        }
                
                        Plotly.newPlot(divName, plotlyData, {});
                    }
                    updatePlot();
                }
                const innerContainer = document.createElement('div');
                innerContainer.classList.add('inner-container');
                const leftContainer = document.createElement('div');
                leftContainer.classList.add('left-container');
                const rightContainer = document.createElement('div');
                rightContainer.classList.add('right-container');
                
                const myDiv = document.createElement('div');
                myDiv.id = 'myDiv';

                leftContainer.appendChild(myDiv);

                innerContainer.appendChild(leftContainer);
                innerContainer.appendChild(rightContainer);

                containerElem.appendChild(innerContainer);
                drawBox(boxPos, boxSize, itemPosList, itemSizeList, 0, myDiv, leftContainer, productCodeList, rightContainer);
            }
            getData();
        });
    </script>
</body>
</html>
